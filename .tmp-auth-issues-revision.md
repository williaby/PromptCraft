---
## **Issue #AUTH-5: Streamlined Authentication Testing**
**Priority**: MEDIUM  
**Estimated Time**: 1 hour (reduced from 3 hours)
**Status**: Open
**Phase**: 1
### Description
Simplified testing and validation of streamlined authentication implementation focused on core functionality: email whitelist validation, header extraction, and basic session management.

**Note**: This issue has been streamlined based on the simplified cloudflared + email whitelist architecture. Complex testing scenarios (performance benchmarking, security penetration testing, load testing) have been eliminated as Cloudflare Access provides the security layer.
### Acceptance Criteria
- [ ] Email whitelist validation works correctly
- [ ] Cloudflare header extraction functions properly  
- [ ] Admin role detection works for configured admin emails
- [ ] Basic session management functional
- [ ] Gradio UI authentication functional
- [ ] Basic audit logging captures login events
### Testing Categories (Simplified)
**Functional Testing**:
- Email whitelist validation (authorized/unauthorized emails)
- Domain whitelist validation (@domain.com format)
- Admin privilege detection
- Cloudflare header parsing

**Integration Testing**:
- Gradio UI with Cloudflare Access headers
- FastAPI endpoints with simplified middleware
- Session cookie management
- Basic audit logging

**~~Eliminated Testing~~ (Cloudflare Access handles these)**:
- ~~JWT validation testing~~ (Cloudflare validates JWTs)
- ~~Rate limiting testing~~ (Cloudflare provides DDoS protection)
- ~~Performance benchmarking~~ (Minimal overhead from header extraction)
- ~~Security penetration testing~~ (Cloudflare Access provides security)
- ~~Load testing~~ (Cloudflare handles traffic management)
### Test Scripts (Simplified)
```bash
# Functional validation script
#!/bin/bash
echo "Testing email whitelist validation..."

# Test with development headers (simulating Cloudflare Access)
export CF_ACCESS_EMAIL="admin@example.com"
curl -H "Cf-Access-Authenticated-User-Email: $CF_ACCESS_EMAIL" \
     http://localhost:7860/api/v1/health && echo "✓ Admin email authorized"

export CF_ACCESS_EMAIL="unauthorized@example.com"
curl -H "Cf-Access-Authenticated-User-Email: $CF_ACCESS_EMAIL" \
     http://localhost:7860/api/v1/health || echo "✓ Unauthorized email rejected"

echo "✓ Basic authentication testing complete"
```

```python
# Unit tests for simplified components
# tests/unit/auth/test_streamlined_auth.py
def test_email_whitelist_validation():
    validator = EmailWhitelistValidator(
        whitelist=["user@example.com", "@company.com"],
        admin_emails=["admin@example.com"]
    )
    
    assert validator.is_authorized("user@example.com")
    assert validator.is_authorized("anyone@company.com")
    assert not validator.is_authorized("hacker@evil.com")
    assert validator.is_admin("admin@example.com")

def test_cloudflare_header_extraction():
    extractor = CloudflareHeaderExtractor()
    mock_request = MockRequest(headers={
        "Cf-Access-Authenticated-User-Email": "test@example.com"
    })
    
    assert extractor.extract_user_email(mock_request) == "test@example.com"
```
### Dependencies
- Issues #AUTH-1, #AUTH-2, #AUTH-3 completed (streamlined versions)
- AUTH-4 testing resolved (current work)
- AUTH-6 feature flags implemented
### Definition of Done  
- Email whitelist validation tests pass
- Header extraction tests pass
- Basic integration tests successful
- Gradio UI functional with authentication
- Simple audit logging verified
- Ready for cloudflared tunnel deployment
---
## **Issue #AUTH-6: Authentication Feature Flag Implementation**
**Priority**: HIGH
**Estimated Time**: 1 hour  
**Status**: Open
**Phase**: 1
### Description
Implement feature flag system to enable safe migration from complex JWT-based authentication to streamlined cloudflared + email whitelist approach. This allows gradual rollout and easy rollback if issues are discovered.
### Acceptance Criteria
- [ ] Feature flag configuration system implemented
- [ ] AUTH_MODE environment variable controls authentication approach
- [ ] Legacy JWT validation can be disabled via feature flags
- [ ] Database session tracking can be disabled via feature flags
- [ ] Service token management can be disabled via feature flags
- [ ] Advanced monitoring can be disabled via feature flags
- [ ] Rate limiting can be disabled via feature flags
- [ ] Configuration validation ensures only compatible features are enabled
- [ ] Documentation updated with feature flag usage
### Technical Implementation
**Environment Configuration:**
```bash
# .env - Authentication feature flags
PROMPTCRAFT_AUTH_MODE=cloudflare_simple  # cloudflare_full | cloudflare_simple
PROMPTCRAFT_ENABLE_LEGACY_JWT_VALIDATION=false
PROMPTCRAFT_ENABLE_DATABASE_SESSIONS=false
PROMPTCRAFT_ENABLE_SERVICE_TOKENS=false
PROMPTCRAFT_ENABLE_ADVANCED_MONITORING=false
PROMPTCRAFT_ENABLE_RATE_LIMITING=false
```

**Configuration Model:**
```python
# src/config/auth_flags.py
class AuthenticationFeatureFlags(BaseModel):
    """Feature flags for authentication system."""
    
    auth_mode: Literal["cloudflare_full", "cloudflare_simple"] = "cloudflare_simple"
    enable_legacy_jwt_validation: bool = False
    enable_database_sessions: bool = False
    enable_service_tokens: bool = False
    enable_advanced_monitoring: bool = False
    enable_rate_limiting: bool = False
    
    @validator('auth_mode')
    def validate_mode_compatibility(cls, v, values):
        """Ensure feature flags are compatible with auth mode."""
        if v == "cloudflare_simple":
            # Simple mode should not have complex features enabled
            if any([
                values.get('enable_legacy_jwt_validation'),
                values.get('enable_service_tokens'),
                values.get('enable_advanced_monitoring')
            ]):
                raise ValueError(
                    "cloudflare_simple mode incompatible with legacy features"
                )
        return v
```

**Dependency Injection Updates:**
```python
# src/auth/container.py
def create_auth_container(flags: AuthenticationFeatureFlags):
    """Create authentication container based on feature flags."""
    
    if flags.auth_mode == "cloudflare_simple":
        return SimpleAuthContainer(
            whitelist_validator=EmailWhitelistValidator(...),
            session_manager=SimpleSessionManager(...) if flags.enable_database_sessions 
                           else InMemorySessionManager(...),
            audit_logger=SimpleAuditLogger(...) if flags.enable_advanced_monitoring
                        else BasicAuditLogger(...)
        )
    else:
        return LegacyAuthContainer(...)  # Full JWT implementation
```
### Feature Flag Strategy
**Migration Path**:
1. **Phase 1**: Deploy with legacy mode enabled (no functional change)
2. **Phase 2**: Switch to simple mode with database sessions enabled  
3. **Phase 3**: Disable database sessions, use in-memory only
4. **Phase 4**: Disable advanced monitoring, use basic audit logging
5. **Phase 5**: Full simple mode deployment

**Rollback Strategy**:
- Environment variable change enables immediate rollback
- Feature flags preserved during rollback for rapid re-deployment
- No database migrations required (features disabled, not removed)
### Testing Strategy
```bash
# Test feature flag combinations
./scripts/test_auth_modes.sh cloudflare_simple
./scripts/test_auth_modes.sh cloudflare_full

# Test migration scenarios
./scripts/test_auth_migration.sh simple_to_full
./scripts/test_auth_migration.sh full_to_simple
```
### Dependencies
- Configuration management system
- Dependency injection system
- Environment variable validation
### Definition of Done
- Feature flag system implemented and tested
- All auth modes functional
- Migration path validated
- Rollback procedure tested
- Configuration validation working
- Documentation complete