# Codecov Configuration for PromptCraft-Hybrid
# See: https://docs.codecov.com/docs/codecov-yaml
# Validation: https://codecov.io/validate

codecov:
  # Token is provided via CODECOV_TOKEN environment variable in GitHub Actions
  ci:
    - github
  branch: main
  max_report_age: "24h"  # Increased for better historical coverage
  notify:
    after_n_builds: 2  # Wait for both Python versions to upload
    wait_for_ci: true   # Wait for CI to stabilize comparisons
  require_ci_to_pass: false  # Allow uploads even if CI hasn't completed
  # Handle missing base commits gracefully
  assume_all_flags: false  # Only process flags that are uploaded
  # Improve commit comparison
  disable_default_path_fixes: false
  strict_yaml_branch: main

coverage:
  precision: 2
  round: down
  range: 70...95

  status:
    project:
      default:
        # Primary blocking check - combines all parallel test results
        target: auto  # Compare against base commit (main branch)
        threshold: 1%  # Allow 1% drop without failing
        if_not_found: success
        informational: false  # This is blocking
    patch:
      default:
        # Ensure new code has good coverage
        target: 85%
        threshold: 2%
        if_not_found: success
        only_pulls: true
        informational: false  # This is blocking

  ignore:
    - "tests/"
    - "scripts/"
    - "docs/"
    - "htmlcov/"
    - "*.html"
    - "*.js"
    - "*.css"
    - "*/__pycache__/"
    - "*/migrations/"
    - "*/vendor/"
    - "*/node_modules/"
    - "noxfile.py"
    - ".github/"
    - "docker/"
    - "*.yaml"
    - "*.yml"
    - "*.toml"
    - "*.cfg"
    - "*.ini"
    - "Dockerfile*"
    - ".env*"
    - "requirements*.txt"
    - "pyproject.toml"

# Component definitions for different parts of the codebase
# Components provide automatic groupings based on file paths and flags
component_management:
  individual_components:
    - component_id: core
      name: "Core Business Logic"
      paths:
        - src/core/
      flag_regexes:
        - unit
        - integration

    - component_id: agents
      name: "Agent System"
      paths:
        - src/agents/
      flag_regexes:
        - unit

    - component_id: auth
      name: "Authentication & Security"
      paths:
        - src/auth/
        - src/security/
      flag_regexes:
        - auth
        - unit

    - component_id: config
      name: "Configuration Management"
      paths:
        - src/config/
      flag_regexes:
        - unit
        - auth

    - component_id: utils
      name: "Utility Modules"
      paths:
        - src/utils/
      flag_regexes:
        - unit
        - auth

    - component_id: ui
      name: "User Interface"
      paths:
        - src/ui/
      flag_regexes:
        - integration

    - component_id: api
      name: "API Layer"
      paths:
        - src/api/
      flag_regexes:
        - unit
        - integration

    - component_id: mcp_integration
      name: "MCP Integration"
      paths:
        - src/mcp_integration/
      flag_regexes:
        - unit
        - integration

# Flag definitions for different test types with carryforward enabled
# This is the KEY to solving the coverage discrepancy
flags:
  # Main flags aligned with test structure - all with carryforward enabled
  unit:
    paths:
      - src/  # Measure all source code for comprehensive comparison
    carryforward: true  # CRITICAL: This enables intelligent merging of partial reports

  auth:
    paths:
      - src/  # Measure all source code for comprehensive comparison
    carryforward: true  # CRITICAL: This enables intelligent merging of partial reports

  integration:
    paths:
      - src/  # Measure all source code for comprehensive comparison
    carryforward: true  # CRITICAL: This enables intelligent merging of partial reports


# Parser configurations for Python coverage reports
parsers:
  gcov:
    branch_detection:
      conditional: true
      loop: true
      method: false
      macro: false

  javascript:
    enable_partials: false

# Comment configuration for PR updates
comment:
  layout: "reach, diff, flags, files, footer"
  behavior: default
  require_changes: false
  require_base: false  # Don't require base commit for comparison
  require_head: true
  branches:
    - main
    - develop
    - "feature/*"
    - "fix/*"
  # Show which flags were carried forward for transparency
  show_carryforward_flags: true
  # Additional flag visibility settings
  after_n_builds: 1  # Reduce wait time for flag processing

# Pull request settings (commented - not supported in current Codecov API)
# pull_request_only_files:
#   - "*.md"
#   - "docs/"
#   - ".github/"

# Notification settings
github_checks:
  annotations: true

fixes:
  - "src/::src/"
  - "tests/::tests/"

# Profiling settings for enterprise features
profiling:
  critical_files_paths:
    - src/core/
    - src/agents/
    - src/config/
