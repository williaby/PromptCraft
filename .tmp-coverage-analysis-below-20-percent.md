# Coverage Analysis Report: Functions and Classes Below 20% Coverage

## Summary
Based on the pytest coverage report, there are **2 files with coverage below 20%**:

1. **src/auth/services/security_integration.py** - 17.69% coverage
2. **src/auth/database/security_events_postgres.py** - 21.93% coverage (just above threshold)

## Critical Files with Very Low Coverage (<20%)

### 1. src/auth/services/security_integration.py (17.69% coverage)
- **Total Lines**: 543 statements
- **Missed Lines**: 417 statements
- **Branch Coverage**: 226 branches, 10 partial

#### Uncovered Classes/Methods:
- `SecurityIntegrationService` class - Most methods are not covered:
  - `_create_default_notification_handlers()` - Lines 153-158
  - `_start_background_tasks()` - Lines 159-393
  - `_add_to_correlation_window()` - Lines 394-402
  - `_find_correlated_events()` - Lines 403-441
  - `_is_service_healthy()` - Lines 442-448
  - `_update_processing_metrics()` - Lines 449-458
  - `_update_enrichment_metrics()` - Lines 459-496
  - `_reset_failure_counts()` - Lines 497-532
  - Large blocks of uncovered code (184-345, 353-392, 533-583, 601-644, 663-696, 714-762, 786-855, 871-900, 911-964, 981-1077, 1086-1132, 1137-1156, 1172-1296, 1325-1500, 1519-1550)
  - `_simulate_search_results()` - Lines 1083+
  - `_generate_investigation_recommendations()` - Lines 1510+

### 2. src/auth/database/security_events_postgres.py (21.93% coverage - Just Above Threshold)
- **Total Lines**: 210 statements  
- **Missed Lines**: 162 statements
- **Branch Coverage**: 18 branches, 0 partial

#### Uncovered Methods:
- `initialize()` - Lines 63-77
- `log_security_event()` - Lines 97-135
- `get_events_by_user()` - Lines 157-181
- `get_events_by_ip()` - Lines 199-227
- `get_recent_events()` - Lines 245-268
- `cleanup_old_events()` - Lines 279-309
- `get_events_by_date_range()` - Lines 327-349
- `cleanup_expired_events()` - Lines 365-394
- `vacuum_database()` - Lines 401-412
- `get_events_by_user_id()` - Lines 453-467
- `get_events_by_type()` - Lines 496-524
- `get_statistics()` - Lines 532-564
- `_model_to_response()` - Lines 601-605

## Files with Low Coverage (26-40%)

### 3. src/auth/services/notification_handlers.py (26.32% coverage)
- **Total Lines**: 178 statements
- **Missed Lines**: 118 statements

#### Uncovered Classes:
- `WebhookHandler` - Most methods uncovered (91-92, 103-123, 127-150, 154-178, 182-191, 195-197)
- `EmailHandler` - Entirely uncovered (205, 216-227, 231-260, 264-277, 297-319)  
- `SlackHandler` - Entirely uncovered (385-386, 397-407, 411-448, 452-454)

### 4. src/automation/token_rotation_scheduler.py (39.92% coverage)
- **Total Lines**: 196 statements
- **Missed Lines**: 110 statements
- Large uncovered blocks (105-174, 221-257, 327-356, 452-502, 510-541, 554-587)

## Recommendations

### Priority 1: Critical Security Components
The security integration service and PostgreSQL security events database have critically low coverage. These are core security components that should have comprehensive test coverage.

**Action Items:**
1. Add integration tests for `SecurityIntegrationService` focusing on:
   - Event correlation and enrichment pipeline
   - Service health monitoring
   - Notification handler creation
   - Background task management
   
2. Add database tests for `SecurityEventsPostgreSQL` covering:
   - All CRUD operations
   - Query methods (by user, IP, date range)
   - Cleanup and maintenance operations
   - Statistics generation

### Priority 2: Notification System
The notification handlers (Webhook, Email, Slack) have very low coverage and are critical for alerting.

**Action Items:**
1. Mock external services and test notification delivery
2. Test template substitution and payload building
3. Test error handling and retry logic

### Priority 3: Automation Components  
Token rotation scheduler needs better coverage for automated security operations.

**Action Items:**
1. Test scheduling logic
2. Test token rotation workflows
3. Mock time-based operations

## Coverage Goals
- Immediate: Bring critical security files above 50% coverage
- Short-term: Achieve 70% coverage for all security-related modules
- Long-term: Maintain 80%+ coverage as per project standards