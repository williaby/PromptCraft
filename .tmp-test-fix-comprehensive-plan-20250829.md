# Comprehensive Test Fix Plan - Aug 29, 2025

## Status Overview
- **Total Failing Tests**: 99
- **Root Causes Identified**: 4
- **Current Phase**: Phase 1 - Dependency Injection Fixes
- **Agent Strategy**: Multi-agent approach with specialized assignments

## Detailed Failure Analysis

### Category 1: Dependency Injection Pattern Mismatch (90 tests)
**Files Affected:**
- `tests/unit/api/test_auth_endpoints.py` (11 failures)
  - test_create_service_token_creation_failed
  - test_revoke_service_token_success  
  - test_revoke_service_token_not_found
  - test_rotate_service_token_success
  - test_rotate_service_token_not_found
  - test_list_service_tokens_success
  - test_list_service_tokens_exception
  - test_get_token_analytics_success
  - test_get_token_analytics_not_found
  - test_emergency_revoke_all_tokens_success
  - test_emergency_revoke_missing_confirmation

- `tests/unit/auth/api/routers/test_charts_router.py` (10 failures)
- `tests/unit/auth/api/routers/test_health_router.py` (7 failures)  
- `tests/unit/auth/api/routers/test_users_router.py` (10 failures)
- `tests/unit/auth/api/routers/test_events_router.py` (2 failures)
- `tests/unit/auth/api/routers/test_metrics_router.py` (2 failures)
- Security Dashboard tests (48 failures across 5 files)

**Root Cause**: Tests use monkeypatch.setattr instead of FastAPI dependency_overrides

**Fix Pattern Required:**
```python
# OLD (failing) pattern:
monkeypatch.setattr("src.api.auth_endpoints.require_role", lambda r, role: mock_user)
monkeypatch.setattr(ServiceTokenManager, "create_service_token", mock_manager.create_service_token)

# NEW (working) pattern:
app.dependency_overrides[require_role] = lambda role: lambda: mock_user  
app.dependency_overrides[ServiceTokenManager] = lambda: mock_manager
```

### Category 2: JWT Validator Test Issues (4 tests)
**Files Affected:**
- `tests/unit/auth/test_jwt_validator_comprehensive.py`
  - test_validate_token_format_invalid_structure
  - test_validate_token_format_malformed_json
  - test_validate_token_missing_kid_header
  - test_validate_token_unicode_characters

**Root Cause**: Test assertions expect different error messages than current implementation

### Category 3: Missing Service Initialization (3 tests)  
**Files Affected:**
- Router tests missing SecurityIntegrationService mocks
- Missing AlertEngine dependencies

### Category 4: Async/Await Pattern Issues (2 tests)
**Files Affected:**
- Tests with incorrect async/await usage

## Agent Assignment Strategy

### Phase 1: Debug Agent (mcp__zen__debug)
**Task**: Comprehensive analysis of all 90 dependency injection failures
**Context**: Full access to failing test files + working test patterns
**Deliverables**:
- Root cause analysis report
- Universal fix template
- Systematic fix implementation

### Phase 2: Test Engineer Agent (mcp__zen__testgen) 
**Task**: JWT validator test updates + service mock infrastructure
**Context**: JWT validator implementation + current test failures
**Deliverables**:
- Updated JWT test assertions
- Proper service mock fixtures

### Phase 3: Code Review Agent (mcp__zen__codereview)
**Task**: Comprehensive validation of all fixes
**Context**: All modified test files + passing test patterns  
**Deliverables**:
- Quality assurance review
- Regression prevention validation

## Implementation Progress

### âœ… Completed
- Root cause analysis
- Agent assignment strategy
- Comprehensive plan approval

### ðŸ”„ Phase 1 In Progress
- [ ] Debug Agent: Dependency injection analysis
- [ ] Universal pattern template creation
- [ ] Auth endpoints test fixes
- [ ] Router test fixes
- [ ] Security dashboard test fixes

### ðŸŸ¡ Phase 2 Pending
- [ ] Test Engineer: JWT validator fixes
- [ ] Service mock infrastructure

### ðŸŸ¡ Phase 3 Pending  
- [ ] Code Review: Comprehensive validation
- [ ] Regression testing

## Risk Mitigation
- Backup created before modifications
- Incremental testing after each phase
- Agent context maximization to prevent cascade failures
- Progress tracking via this reference file

## Success Metrics
- Target: 99 failing tests â†’ 0 failing tests
- No regression in 4502 passing tests
- Maintain 73%+ test coverage

---
**Last Updated**: 2025-08-29 (Plan approved, execution started)
**Next Update**: After Phase 1 Debug Agent analysis completion