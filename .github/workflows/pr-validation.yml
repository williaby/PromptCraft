name: PR Validation

on:
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-requirements:
    name: Validate Requirements Sync
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'develop'

    steps:
      - uses: actions/checkout@v4
        with:
          # Fetch full history to ensure we can compare with base branch
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 2.1.2
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install Poetry Export Plugin
        run: poetry self add poetry-plugin-export

      - name: Install dependencies
        run: poetry install

      - name: Check if poetry.lock changed
        id: poetry-changed
        run: |
          git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | \
            grep -q "poetry.lock" && echo "changed=true" >> $GITHUB_OUTPUT || echo "changed=false" >> $GITHUB_OUTPUT

      - name: Validate requirements.txt sync
        if: steps.poetry-changed.outputs.changed == 'true'
        run: |
          echo "🔍 Poetry.lock has changed, validating requirements.txt sync..."

          # Generate requirements from current poetry.lock
          ./scripts/generate_requirements.sh

          # Check if generated files match committed files
          if ! git diff --exit-code requirements*.txt; then
            echo "::error::Requirements files are out of sync with poetry.lock"
            echo "::error::This PR modifies poetry.lock but the requirements files don't match."
            echo "::error::Please run './scripts/generate_requirements.sh' and commit the updated requirements files."
            echo ""
            echo "📋 Files that need to be updated:"
            git diff --name-only requirements*.txt
            echo ""
            echo "🔧 To fix this issue:"
            echo "1. Run: ./scripts/generate_requirements.sh"
            echo "2. Review and commit the updated requirements files"
            echo "3. Push the changes to this PR branch"
            exit 1
          else
            echo "✅ Requirements files are properly synchronized with poetry.lock"
          fi

      - name: Skip validation (no poetry.lock changes)
        if: steps.poetry-changed.outputs.changed == 'false'
        run: |
          echo "✅ Poetry.lock unchanged - requirements validation skipped"
          echo "No dependency changes detected in this PR."
