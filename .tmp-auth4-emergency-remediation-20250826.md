# AUTH-4 Emergency Remediation Plan - 2025-08-26

## Critical System Status
**SYSTEM STATE**: ❌ **BROKEN - AUTHENTICATION NON-FUNCTIONAL**
- Authentication Middleware: ❌ FAILING (cannot log events)
- Database Integration: ❌ FAILING (table mismatches)  
- Test Suite: ❌ FAILING (129 failed, 8 errors, timeouts)
- Production Readiness: ❌ CRITICAL (system would not start)

## Root Cause Analysis

### 1. Database Architecture Inconsistency (CRITICAL)
- **Issue**: Dual database system (SQLite + PostgreSQL) with schema mismatches
- **Evidence**: `asyncpg.exceptions.UndefinedTableError: relation "security_events_monitor" does not exist`
- **Impact**: ALL authentication events fail to persist to database

### 2. Service Integration Failures (HIGH)  
- **Issue**: Services using different database backends and schemas
- **Evidence**: SecurityLogger ✅ uses PostgreSQL, SecurityMonitor ❌ uses SQLite table names
- **Impact**: Authentication middleware cannot log events

### 3. Async Context Management Issues (HIGH)
- **Issue**: Tests timeout after 30 seconds with asyncio hanging
- **Evidence**: 38+ tests timeout in middleware test suite
- **Impact**: System hangs under normal operations

## Emergency Tasks (Agent Assignments)

### TASK 1 - Database Schema Consolidation (EMERGENCY - 2h)
**Assigned to**: Security Agent via mcp__zen__secaudit
**Priority**: CRITICAL - System completely broken
**Scope**: Fix database table mismatch causing authentication failures

**Actions Required**:
1. Analyze current database schema inconsistencies
2. Create unified schema using existing `security_events` table
3. Update SecurityMonitor service to use correct table names
4. Validate database operations work correctly

**Files to Focus**:
- `src/auth/services/security_monitor.py` - Update table references
- `migrations/` - Ensure schema consistency
- `src/database/models.py` - Validate model definitions

**Acceptance Criteria**:
- [ ] SecurityMonitor uses `security_events` table (not `security_events_monitor`)
- [ ] All services use same PostgreSQL database exclusively
- [ ] Database operations complete without table not found errors
- [ ] Authentication middleware can log events successfully

### TASK 2 - Authentication Event Model Fixes (EMERGENCY - 1h)
**Assigned to**: Code Review Agent via mcp__zen__codereview
**Priority**: CRITICAL - Authentication broken
**Scope**: Fix parameter mismatches in authentication event logging

**Actions Required**:
1. Fix 'service_token_name' parameter error in middleware
2. Align event model parameters across all services
3. Update authentication event creation calls
4. Test event logging works correctly

**Files to Focus**:
- `src/auth/middleware.py:599` - Fix event logging parameters
- `src/auth/models.py` - Validate AuthenticationEvent model
- `src/auth/services/security_logger.py` - Ensure parameter alignment

**Acceptance Criteria**:
- [ ] No "invalid keyword argument" errors for AuthenticationEvent
- [ ] Authentication events log successfully to database
- [ ] Parameter names consistent across all services
- [ ] Middleware authentication flows work without errors

### TASK 3 - Async Context Manager Fixes (HIGH - 2h)
**Assigned to**: Refactor Agent via mcp__zen__refactor
**Priority**: HIGH - System hangs during operations
**Scope**: Fix async timeout issues causing test hangs

**Actions Required**:
1. Review database session management in authentication services
2. Fix hanging async operations in context managers
3. Ensure proper resource cleanup in async flows
4. Test async operations complete within reasonable timeframes

**Files to Focus**:
- `src/database/connection.py` - Review session management
- `src/auth/services/*.py` - Fix async context usage
- `tests/unit/auth/test_middleware.py` - Validate tests don't hang

**Acceptance Criteria**:
- [ ] Tests complete within 30 seconds (no timeouts)
- [ ] Database sessions properly closed after operations
- [ ] Async context managers work correctly
- [ ] No asyncio event loop hanging issues

### TASK 4 - Service Integration Testing (HIGH - 2h)  
**Assigned to**: Test Engineer Agent via mcp__zen__testgen
**Priority**: HIGH - Validate fixes work correctly
**Scope**: Fix unit test failures and validate service integration

**Actions Required**:
1. Update test fixtures for PostgreSQL-only architecture
2. Fix 75+ failing AUTH service unit tests
3. Ensure integration tests work with fixed services
4. Validate complete authentication workflows

**Files to Focus**:
- `tests/unit/auth/services/test_*.py` - Fix service test failures
- `tests/integration/test_auth*.py` - Fix integration test failures  
- `tests/fixtures/security_service_mocks.py` - Update test mocks
- `tests/conftest.py` - Update test database fixtures

**Acceptance Criteria**:
- [ ] All unit tests pass consistently (0 failures)
- [ ] Integration tests work with PostgreSQL backend
- [ ] Test fixtures properly configured for single database
- [ ] Complete authentication workflows tested end-to-end

## Success Criteria for Emergency Phase

**MANDATORY Requirements**:
- [ ] Authentication middleware works without errors
- [ ] All services use PostgreSQL exclusively (no SQLite)
- [ ] Database operations complete successfully  
- [ ] Tests run without timeouts or hanging
- [ ] Authentication event logging works correctly
- [ ] Core authentication workflows functional

**Quality Gates**:
- [ ] Test pass rate >95% (from current ~25%)
- [ ] Authentication response times <100ms
- [ ] No database table not found errors
- [ ] No async context manager timeouts
- [ ] Services can restart without data loss

## Next Phase Preparation

After emergency remediation:
1. Complete remaining service refactoring (AlertEngine, SuspiciousActivityDetector)
2. Remove SQLite database entirely and security vulnerabilities
3. Implement proper dependency injection
4. Optimize performance for <10ms targets
5. Full security audit and compliance validation

## Risk Mitigation

**Rollback Plan**: 
- Keep current broken state documented
- Test fixes in isolated environment first  
- Progressive rollout with checkpoint validation
- Automated rollback if any regressions detected

**Timeline**: 6-8 hours for emergency stabilization
**Resources**: 4 specialized agents working in parallel
**Validation**: Each agent validates their fixes before handoff